{% extends 'base.html' %}

{% block titulo %}
Inicio
{% endblock %}

{% block page_vendor_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
    .pedido-row-highlight > td {
        background-color: rgba(255, 216, 0, 0.25) !important;
        color: #7a5a00 !important;
    }

    .pedido-row-highlight .badge,
    .pedido-row-highlight a,
    .pedido-row-highlight button,
    .pedido-row-highlight i {
        color: #7a5a00 !important;
    }

    .js-cart-highlight {
        color: #94a3b8;
    }

    .js-cart-highlight.is-active {
        color: #b45309;
    }

    .js-consolidado-cart {
        color: #94a3b8;
    }

    .js-consolidado-cart.is-active {
        color: #b45309;
    }
</style>
{% endblock %}

{% block contenido %}
<div class="container-fluid">
    <div class="row">
        {% for pedido in ultimos_pedidos %}
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                {{ pedido.proveedor.nombre }}
                            </div>
                            <div class="text-xs text-gray-500 mb-1">
                                {{ pedido.get_tipo_huevo_display }} | {{ pedido.get_presentacion_display }}
                                {% if pedido.semana %}
                                - Semana {{ pedido.semana|date:"d/m/Y" }}
                                {% elif pedido.fecha_entrega %}
                                - Entrega {{ pedido.fecha_entrega|date:"d/m/Y" }}
                                {% endif %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ pedido.cantidad_total|default:pedido.cantidad }} kg
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-box fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1" style="color: var(--dashboard-warning);">
                                Pedidos pendientes
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pedidos_pendientes }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-hourglass-half fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1" style="color: var(--dashboard-success);">
                                Pedidos confirmados
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pedidos_confirmados }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header dashboard-card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        Resumen mensual {{ chart_year }} (kg)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        {{ chart_labels|json_script:"chart-labels" }}
                        {{ chart_pendientes_data|json_script:"chart-pendientes-data" }}
                        {{ chart_confirmados_data|json_script:"chart-confirmados-data" }}
                        <canvas id="myAreaChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header dashboard-card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Toneladas por ciudad</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        {{ city_labels|json_script:"city-labels" }}
                        {{ city_data|json_script:"city-data" }}
                        <canvas id="myPieChart"></canvas>
                    </div>
                    <div class="mt-3 text-center">
                        <div class="text-xs text-uppercase text-muted">Total general</div>
                        <div class="h5 font-weight-bold text-gray-800">{{ total_toneladas }} toneladas</div>
                    </div>
                    <div class="mt-4 text-center small">
                        <span class="mr-2">
                            <i class="fas fa-circle text-primary"></i> Bogota
                        </span>
                        <span class="mr-2">
                            <i class="fas fa-circle" style="color: var(--dashboard-success);"></i> Medellin
                        </span>
                        <span class="mr-2">
                            <i class="fas fa-circle" style="color: var(--dashboard-warning);"></i> Cali
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header dashboard-card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        Materia prima vs creado por comerciales {{ chart_year }} (kg)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        {{ chart_materia_prima_data|json_script:"chart-materia-prima-data" }}
                        {{ chart_comerciales_data|json_script:"chart-comerciales-data" }}
                        {{ chart_balance_data|json_script:"chart-balance-data" }}
                        <canvas id="mpVsComercialesChart"></canvas>
                    </div>
                    <p class="small text-muted mb-0">
                        El balance se calcula como <strong>materia prima - pedidos creados por comerciales</strong>.
                        Si es negativo, se marca en rojo.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <h1 class="h3 mb-2 text-gray-800">LISTADO PENDIENTES Y CONFIRMADOS</h1>

    {% for tabla in tablas_ciudades %}
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">PEDIDOS SEMANALES - {{ tabla.nombre|upper }}</h6>
            <button type="button"
                class="btn btn-outline-secondary btn-sm js-toggle-card-body"
                data-target="pedidosTabla{{ tabla.codigo }}"
                aria-expanded="true">
                Ocultar
            </button>
        </div>
        <div class="card-body" id="pedidosTabla{{ tabla.codigo }}">
            <div class="table-responsive">
                <table class="table table-bordered table-responsive-stack" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>PRESENTACION</th>
                            <th>COMPANIA</th>
                            <th>TIPO DE HUEVO</th>
                            <th>CANTIDAD TOTAL (KG)</th>
                            <th class="col-semana">SEMANA</th>
                            <th>ENTREGAS</th>
                            <th>FECHA/CREACION</th>
                            <th>ESTADO</th>
                            <th>CARRITO</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in tabla.pedidos %}
                        <tr data-pedido-id="{{ pedido.id }}">
                            <td data-label="Presentacion"
                                class="js-dashboard-filter"
                                data-filter-param="presentacion"
                                data-filter-value="{{ pedido.presentacion }}"
                                style="cursor: pointer;">
                                {{ pedido.get_presentacion_display }}
                            </td>
                            <td data-label="Compania">
                                {% if pedido.observaciones %}
                                <button type="button" class="btn btn-link p-0" data-toggle="modal"
                                    data-target="#observacionesModal{{ pedido.id }}">
                                    {{ pedido.proveedor.nombre }}
                                </button>

                                <div class="modal fade" id="observacionesModal{{ pedido.id }}" tabindex="-1" role="dialog"
                                    aria-labelledby="observacionesModalLabel{{ pedido.id }}" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header"
                                                style="background: linear-gradient(90deg, rgba(37, 99, 235, 0.12), rgba(14, 165, 163, 0.12));">
                                                <h5 class="modal-title" id="observacionesModalLabel{{ pedido.id }}">
                                                    Observaciones del pedido
                                                </h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <p class="small text-muted mb-2">
                                                    {{ pedido.proveedor.nombre }} &middot; {{ pedido.get_tipo_huevo_display }}
                                                </p>
                                                <div class="p-3" style="background: #f8fafc; border-radius: 0.75rem;">
                                                    {{ pedido.observaciones|linebreaksbr }}
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                                    Cerrar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                {{ pedido.proveedor.nombre }}
                                {% endif %}
                            </td>
                            <td data-label="Tipo de huevo">
                                {{ pedido.get_tipo_huevo_display }}
                            </td>
                            <td data-label="Cantidad total (kg)">
                                {{ pedido.cantidad_total|default:pedido.cantidad }}
                            </td>
                            <td data-label="Semana" class="col-semana">
                                {{ pedido.semana|date:"d/m/Y" }}
                            </td>
                            <td data-label="Entregas">
                                {% with entregas=pedido.entregas.all %}
                                {% with entregas_count=entregas|length %}
                                {% if entregas_count > 0 or pedido.fecha_entrega %}
                                <button type="button" class="btn btn-link p-0" data-toggle="modal"
                                    data-target="#entregasModal{{ pedido.id }}" title="Ver calendario de entregas">
                                    <i class="fas fa-calendar-alt text-primary"></i>
                                    <span class="small text-muted">
                                        ({% if entregas_count > 0 %}{{ entregas_count }}{% else %}1{% endif %})
                                    </span>
                                </button>

                                <div class="modal fade" id="entregasModal{{ pedido.id }}" tabindex="-1" role="dialog"
                                    aria-labelledby="entregasModalLabel{{ pedido.id }}" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="entregasModalLabel{{ pedido.id }}">
                                                    Calendario de entregas
                                                </h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <p class="small text-muted mb-2">
                                                    {{ pedido.proveedor.nombre }} &middot; {{ pedido.get_tipo_huevo_display }}
                                                </p>
                                                <div class="delivery-calendar"
                                                    data-user-id="{{ request.user.id }}"
                                                    data-calendar-id="pedido-{{ pedido.id }}"
                                                    data-entregas='[{% if entregas_count > 0 %}{% for entrega in entregas %}{"fecha":"{{ entrega.fecha_entrega|date:"Y-m-d" }}","cantidad":{{ entrega.cantidad }}}{% if not forloop.last %},{% endif %}{% endfor %}{% elif pedido.fecha_entrega %}{"fecha":"{{ pedido.fecha_entrega|date:"Y-m-d" }}","cantidad":{{ pedido.cantidad_total|default:pedido.cantidad|default:0 }}}{% endif %}]'>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                                    Cerrar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                -
                                {% endif %}
                                {% endwith %}
                                {% endwith %}
                            </td>
                            <td data-label="Fecha/creacion">
                                {{ pedido.fecha_creacion|date:"d/m/Y" }}
                            </td>
                            <td data-label="Estado">
                                <span class="badge badge-estado badge-estado-{{ pedido.estado|lower }}">
                                    {{ pedido.get_estado_display }}
                                </span>
                            </td>
                            <td data-label="Carrito" class="text-center">
                                <button type="button"
                                    class="btn btn-link p-0 js-cart-highlight"
                                    title="Marcar fila"
                                    aria-label="Marcar fila"
                                    aria-pressed="false">
                                    <i class="fas fa-shopping-cart"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center text-muted">Sin pedidos</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-3">
                <div class="text-uppercase text-muted small mb-2">Totales por comercial</div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                        <thead>
                            <tr>
                                <th>COMERCIAL</th>
                                <th>TOTAL (KG)</th>
                                <th>TOTAL (TON)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for total in tabla.totales %}
                            <tr>
                                <td>{{ total.comercial }}</td>
                                <td>{{ total.total_kg }} kg</td>
                                <td>{{ total.total_toneladas }} toneladas</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">Sin totales</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th>TOTAL CIUDAD</th>
                                <th>{{ tabla.total_kg }} kg</th>
                                <th>{{ tabla.total_toneladas }} toneladas</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    {% if puede_ver_resumen_consolidado %}
    <div class="card shadow mb-4" id="resumenConsolidadoCard">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">RESUMEN CONSOLIDADO POR SUCURSAL</h6>
            <button type="button"
                class="btn btn-outline-secondary btn-sm js-toggle-card-body"
                data-target="resumenConsolidadoBody"
                aria-expanded="true">
                Ocultar
            </button>
        </div>
        <div class="card-body" id="resumenConsolidadoBody">
            <div class="form-row mb-3">
                <div class="col-12 col-md-4 mb-2">
                    <label class="mb-1">Filtrar por sucursal</label>
                    <select id="resumenSucursalFilter" class="form-control form-control-sm">
                        <option value="">Todas las sucursales</option>
                        {% for bloque in resumen_dashboard_por_ciudad %}
                        <option value="{{ bloque.codigo }}">{{ bloque.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-md-4 mb-2">
                    <label class="mb-1">Filtrar por vida util</label>
                    <select id="resumenVidaUtilFilter" class="form-control form-control-sm">
                        <option value="">Todas las vidas utiles</option>
                        {% for vida_util in resumen_dashboard_vida_utiles %}
                        <option value="{{ vida_util|lower }}">{{ vida_util }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            {% for bloque in resumen_dashboard_por_ciudad %}
            <div class="card border mb-3 js-consolidado-ciudad-card" data-sucursal="{{ bloque.codigo }}">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <strong class="text-primary mb-0">SUCURSAL - {{ bloque.nombre|upper }}</strong>
                    <button type="button"
                        class="btn btn-outline-secondary btn-sm js-toggle-card-body"
                        data-target="consolidadoTabla{{ bloque.codigo }}"
                        aria-expanded="true">
                        Ocultar
                    </button>
                </div>
                <div class="card-body p-0" id="consolidadoTabla{{ bloque.codigo }}">
                    <div class="table-responsive">
                        <table class="table table-bordered table-responsive-stack mb-0 js-consolidado-table" width="100%" cellspacing="0" data-sucursal="{{ bloque.codigo }}">
                            <thead>
                                <tr>
                                    <th>PRESENTACION</th>
                                    <th>VIDA UTIL</th>
                                    <th>TOTAL (KG)</th>
                                    <th>FABRICADO (KG)</th>
                                    <th>PENDIENTE (KG)</th>
                                    <th>CARRITO</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if bloque.rows %}
                                {% for row in bloque.rows %}
                                <tr
                                    data-consolidado-key="{{ row.row_key|escape }}"
                                    data-sucursal="{{ bloque.codigo }}"
                                    data-vida-util="{{ row.vida_util|lower }}">
                                    <td data-label="Presentacion">{{ row.presentacion }}</td>
                                    <td data-label="Vida util">{{ row.vida_util }}</td>
                                    <td data-label="Total (kg)" class="js-total-cell" data-total="{{ row.total_kg }}">{{ row.total_kg }}</td>
                                    <td data-label="Fabricado (kg)" class="js-fabricado-cell">0</td>
                                    <td data-label="Pendiente (kg)" class="js-pendiente-cell">{{ row.pendiente_kg }}</td>
                                    <td data-label="Carrito" class="text-center">
                                        <button type="button"
                                            class="btn btn-link p-0 js-consolidado-cart"
                                            title="Marcar fila"
                                            aria-label="Marcar fila"
                                            aria-pressed="false">
                                            <i class="fas fa-shopping-cart"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                <tr class="js-consolidado-empty d-none">
                                    <td colspan="6" class="text-center text-muted">Sin datos para mostrar.</td>
                                </tr>
                                {% else %}
                                <tr class="js-consolidado-empty">
                                    <td colspan="6" class="text-center text-muted">Sin datos para mostrar.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="2">TOTAL {{ bloque.nombre|upper }}</th>
                                    <th class="js-city-total">{{ bloque.totales.total_kg }}</th>
                                    <th class="js-city-fabricado">0</th>
                                    <th class="js-city-pendiente">{{ bloque.totales.pendiente_kg }}</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}

            <div class="card border">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <strong class="text-primary">TOTAL GENERAL - 3 SUCURSALES</strong>
                    <button type="button"
                        class="btn btn-outline-secondary btn-sm js-toggle-card-body"
                        data-target="consolidadoTablaGeneral"
                        aria-expanded="true">
                        Ocultar
                    </button>
                </div>
                <div class="card-body p-0" id="consolidadoTablaGeneral">
                    <div class="table-responsive">
                        <table class="table table-bordered table-responsive-stack mb-0" width="100%" cellspacing="0" id="resumenConsolidadoGeneral">
                            <thead>
                                <tr>
                                    <th>SUCURSAL</th>
                                    <th>PRESENTACION</th>
                                    <th>VIDA UTIL</th>
                                    <th>TOTAL (KG)</th>
                                    <th>FABRICADO (KG)</th>
                                    <th>PENDIENTE (KG)</th>
                                    <th>CARRITO</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bloque in resumen_dashboard_por_ciudad %}
                                {% for row in bloque.rows %}
                                <tr
                                    data-consolidado-key="{{ row.row_key|escape }}"
                                    data-sucursal="{{ bloque.codigo }}"
                                    data-vida-util="{{ row.vida_util|lower }}"
                                    class="js-general-row">
                                    <td data-label="Sucursal">{{ row.sucursal|upper }}</td>
                                    <td data-label="Presentacion">{{ row.presentacion }}</td>
                                    <td data-label="Vida util">{{ row.vida_util }}</td>
                                    <td data-label="Total (kg)" class="js-total-cell" data-total="{{ row.total_kg }}">{{ row.total_kg }}</td>
                                    <td data-label="Fabricado (kg)" class="js-general-fabricado">0</td>
                                    <td data-label="Pendiente (kg)" class="js-general-pendiente">{{ row.pendiente_kg }}</td>
                                    <td data-label="Carrito" class="text-center">
                                        <button type="button"
                                            class="btn btn-link p-0 js-consolidado-cart"
                                            title="Marcar fila"
                                            aria-label="Marcar fila"
                                            aria-pressed="false">
                                            <i class="fas fa-shopping-cart"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endfor %}
                                <tr class="js-general-empty d-none">
                                    <td colspan="7" class="text-center text-muted">Sin datos para mostrar.</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3">TOTAL GENERAL</th>
                                    <th id="resumenConsolidadoTotalKg">{{ resumen_dashboard_totales.total_kg }}</th>
                                    <th id="resumenConsolidadoFabricadoKg">0</th>
                                    <th id="resumenConsolidadoPendienteKg">{{ resumen_dashboard_totales.pendiente_kg }}</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% include "partials/delivery_calendar_assets.html" %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const labels = JSON.parse(document.getElementById("chart-labels").textContent);
        const pendientes = JSON.parse(document.getElementById("chart-pendientes-data").textContent);
        const confirmados = JSON.parse(document.getElementById("chart-confirmados-data").textContent);
        const chartCanvas = document.getElementById("myAreaChart");
        if (!chartCanvas) {
            return;
        }

        const cssVars = getComputedStyle(document.documentElement);
        const pendingColor = cssVars.getPropertyValue("--dashboard-warning").trim() || "#f59e0b";
        const confirmedColor = cssVars.getPropertyValue("--dashboard-success").trim() || "#0ea5a3";

        new Chart(chartCanvas.getContext("2d"), {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "Pendientes (kg)",
                        data: pendientes,
                        fill: true,
                        borderColor: pendingColor,
                        backgroundColor: "rgba(245, 158, 11, 0.14)",
                        tension: 0.3
                    },
                    {
                        label: "Confirmados (kg)",
                        data: confirmados,
                        fill: true,
                        borderColor: confirmedColor,
                        backgroundColor: "rgba(14, 165, 163, 0.14)",
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: "index", intersect: false },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const labels = JSON.parse(document.getElementById("chart-labels").textContent);
        const materiaPrima = JSON.parse(document.getElementById("chart-materia-prima-data").textContent);
        const comerciales = JSON.parse(document.getElementById("chart-comerciales-data").textContent);
        const balance = JSON.parse(document.getElementById("chart-balance-data").textContent);
        const chartCanvas = document.getElementById("mpVsComercialesChart");
        if (!chartCanvas) {
            return;
        }

        const cssVars = getComputedStyle(document.documentElement);
        const mpColor = cssVars.getPropertyValue("--dashboard-primary").trim() || "#2563eb";
        const comercialColor = cssVars.getPropertyValue("--dashboard-warning").trim() || "#f59e0b";
        const balancePositive = "rgba(16, 185, 129, 0.65)";
        const balanceNegative = "rgba(239, 68, 68, 0.65)";
        const balanceColors = balance.map((valor) => (valor < 0 ? balanceNegative : balancePositive));

        new Chart(chartCanvas.getContext("2d"), {
            data: {
                labels: labels,
                datasets: [
                    {
                        type: "line",
                        label: "Materia prima (kg)",
                        data: materiaPrima,
                        borderColor: mpColor,
                        backgroundColor: "rgba(37, 99, 235, 0.12)",
                        fill: false,
                        tension: 0.3
                    },
                    {
                        type: "line",
                        label: "Creado por comerciales (kg)",
                        data: comerciales,
                        borderColor: comercialColor,
                        backgroundColor: "rgba(245, 158, 11, 0.12)",
                        fill: false,
                        tension: 0.3
                    },
                    {
                        type: "bar",
                        label: "Balance (kg)",
                        data: balance,
                        backgroundColor: balanceColors,
                        borderColor: balanceColors,
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: "index", intersect: false },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const labels = JSON.parse(document.getElementById("city-labels").textContent);
        const dataValues = JSON.parse(document.getElementById("city-data").textContent);
        const pieCanvas = document.getElementById("myPieChart");
        if (!pieCanvas) {
            return;
        }

        const cssVars = getComputedStyle(document.documentElement);
        const colors = [
            cssVars.getPropertyValue("--dashboard-primary").trim() || "#2563eb",
            cssVars.getPropertyValue("--dashboard-success").trim() || "#0ea5a3",
            cssVars.getPropertyValue("--dashboard-warning").trim() || "#f59e0b"
        ];

        new Chart(pieCanvas.getContext("2d"), {
            type: "doughnut",
            data: {
                labels: labels,
                datasets: [{
                    label: "Total toneladas",
                    data: dataValues,
                    backgroundColor: colors,
                    borderColor: "#ffffff",
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const cells = document.querySelectorAll(".js-dashboard-filter");
        if (!cells.length) {
            return;
        }
        cells.forEach((cell) => {
            cell.addEventListener("click", function (event) {
                if (event.target.closest("button, a, [data-toggle='modal']")) {
                    return;
                }
                const value = this.dataset.filterValue;
                if (!value) {
                    return;
                }
                const url = new URL(window.location.origin + window.location.pathname);
                url.searchParams.set("presentacion", value);
                window.location.href = url.toString();
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const userId = "{{ request.user.id|default:'0' }}";
        const storageKey = `dashboard-highlighted-rows-user-${userId}`;
        let highlightedRows = {};

        try {
            highlightedRows = JSON.parse(localStorage.getItem(storageKey) || "{}");
        } catch (error) {
            highlightedRows = {};
        }

        const applyHighlight = (row) => {
            const pedidoId = row.dataset.pedidoId;
            if (!pedidoId) {
                return;
            }
            const isActive = Boolean(highlightedRows[pedidoId]);
            row.classList.toggle("pedido-row-highlight", isActive);
            const button = row.querySelector(".js-cart-highlight");
            if (button) {
                button.classList.toggle("is-active", isActive);
                button.setAttribute("aria-pressed", isActive ? "true" : "false");
            }
        };

        document.querySelectorAll("tr[data-pedido-id]").forEach((row) => {
            applyHighlight(row);
        });

        document.querySelectorAll(".js-cart-highlight").forEach((button) => {
            button.addEventListener("click", function (event) {
                event.preventDefault();
                event.stopPropagation();
                const row = this.closest("tr[data-pedido-id]");
                if (!row) {
                    return;
                }
                const pedidoId = row.dataset.pedidoId;
                if (!pedidoId) {
                    return;
                }
                if (highlightedRows[pedidoId]) {
                    delete highlightedRows[pedidoId];
                } else {
                    highlightedRows[pedidoId] = true;
                }
                localStorage.setItem(storageKey, JSON.stringify(highlightedRows));
                applyHighlight(row);
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".js-toggle-card-body").forEach((button) => {
            button.addEventListener("click", function () {
                const targetId = this.dataset.target;
                const target = targetId ? document.getElementById(targetId) : null;
                if (!target) {
                    return;
                }
                const expanded = this.getAttribute("aria-expanded") !== "false";
                target.classList.toggle("d-none", expanded);
                this.setAttribute("aria-expanded", expanded ? "false" : "true");
                this.textContent = expanded ? "Mostrar" : "Ocultar";
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const resumenCard = document.getElementById("resumenConsolidadoCard");
        if (!resumenCard) {
            return;
        }

        const userId = "{{ request.user.id|default:'0' }}";
        const highlightStorageKey = `dashboard-consolidado-highlight-user-${userId}`;
        const sucursalFilter = document.getElementById("resumenSucursalFilter");
        const vidaUtilFilter = document.getElementById("resumenVidaUtilFilter");
        const cards = resumenCard.querySelectorAll(".js-consolidado-ciudad-card");
        const rows = resumenCard.querySelectorAll("tr[data-consolidado-key]");
        const generalTable = document.getElementById("resumenConsolidadoGeneral");
        const generalRows = generalTable
            ? generalTable.querySelectorAll("tbody tr[data-consolidado-key]")
            : [];
        const generalEmptyRow = generalTable
            ? generalTable.querySelector(".js-general-empty")
            : null;
        const totalKgElement = document.getElementById("resumenConsolidadoTotalKg");
        const fabricadoKgElement = document.getElementById("resumenConsolidadoFabricadoKg");
        const pendienteKgElement = document.getElementById("resumenConsolidadoPendienteKg");

        const loadState = (key) => {
            try {
                return JSON.parse(localStorage.getItem(key) || "{}");
            } catch (error) {
                return {};
            }
        };

        const saveState = (key, value) => {
            localStorage.setItem(key, JSON.stringify(value));
        };

        const toInt = (value) => {
            const number = parseInt(value, 10);
            return Number.isNaN(number) ? 0 : number;
        };

        const highlightState = loadState(highlightStorageKey);

        const applyRowHighlight = (row) => {
            const rowKey = row.dataset.consolidadoKey;
            const button = row.querySelector(".js-consolidado-cart");
            if (!rowKey || !button) {
                return;
            }
            const active = Boolean(highlightState[rowKey]);
            row.classList.toggle("pedido-row-highlight", active);
            button.classList.toggle("is-active", active);
            button.setAttribute("aria-pressed", active ? "true" : "false");
        };

        const applyHighlightByKey = (rowKey) => {
            rows.forEach((row) => {
                if (row.dataset.consolidadoKey === rowKey) {
                    applyRowHighlight(row);
                }
            });
        };

        const updateTotals = () => {
            cards.forEach((card) => {
                const table = card.querySelector(".js-consolidado-table");
                if (!table) {
                    return;
                }

                let cityTotal = 0;
                let cityPendiente = 0;
                let visibleRows = 0;

                table.querySelectorAll("tbody tr[data-consolidado-key]").forEach((row) => {
                    if (row.classList.contains("d-none")) {
                        return;
                    }
                    const totalCell = row.querySelector(".js-total-cell");
                    const rowTotal = toInt(totalCell?.dataset.total || totalCell?.textContent || 0);
                    cityTotal += rowTotal;
                    cityPendiente += rowTotal;
                    visibleRows += 1;
                });

                const emptyRow = table.querySelector(".js-consolidado-empty");
                if (emptyRow) {
                    emptyRow.classList.toggle("d-none", visibleRows > 0);
                }

                const cityTotalCell = table.querySelector(".js-city-total");
                const cityFabricadoCell = table.querySelector(".js-city-fabricado");
                const cityPendienteCell = table.querySelector(".js-city-pendiente");
                if (cityTotalCell) {
                    cityTotalCell.textContent = cityTotal;
                }
                if (cityFabricadoCell) {
                    cityFabricadoCell.textContent = 0;
                }
                if (cityPendienteCell) {
                    cityPendienteCell.textContent = cityPendiente;
                }
            });

            let totalKg = 0;
            let pendienteKg = 0;
            let generalVisibleRows = 0;
            generalRows.forEach((row) => {
                if (row.classList.contains("d-none")) {
                    return;
                }
                const totalCell = row.querySelector(".js-total-cell");
                const rowTotal = toInt(totalCell?.dataset.total || totalCell?.textContent || 0);
                totalKg += rowTotal;
                pendienteKg += rowTotal;
                generalVisibleRows += 1;
            });
            if (generalEmptyRow) {
                generalEmptyRow.classList.toggle("d-none", generalVisibleRows > 0);
            }

            if (totalKgElement) {
                totalKgElement.textContent = totalKg;
            }
            if (fabricadoKgElement) {
                fabricadoKgElement.textContent = 0;
            }
            if (pendienteKgElement) {
                pendienteKgElement.textContent = pendienteKg;
            }
        };

        const applyFilters = () => {
            const sucursalSeleccionada = (sucursalFilter?.value || "").toUpperCase();
            const vidaUtilSeleccionada = (vidaUtilFilter?.value || "").toLowerCase();

            cards.forEach((card) => {
                const sucursalCard = (card.dataset.sucursal || "").toUpperCase();
                const coincideSucursal = !sucursalSeleccionada || sucursalCard === sucursalSeleccionada;
                card.classList.toggle("d-none", !coincideSucursal);

                card.querySelectorAll("tbody tr[data-consolidado-key]").forEach((row) => {
                    const rowVidaUtil = (row.dataset.vidaUtil || "").toLowerCase();
                    const coincideVidaUtil = !vidaUtilSeleccionada || rowVidaUtil === vidaUtilSeleccionada;
                    row.classList.toggle("d-none", !(coincideSucursal && coincideVidaUtil));
                });
            });

            generalRows.forEach((row) => {
                const rowSucursal = (row.dataset.sucursal || "").toUpperCase();
                const rowVidaUtil = (row.dataset.vidaUtil || "").toLowerCase();
                const coincideSucursal = !sucursalSeleccionada || rowSucursal === sucursalSeleccionada;
                const coincideVidaUtil = !vidaUtilSeleccionada || rowVidaUtil === vidaUtilSeleccionada;
                row.classList.toggle("d-none", !(coincideSucursal && coincideVidaUtil));
            });

            updateTotals();
        };

        rows.forEach((row) => {
            const rowKey = row.dataset.consolidadoKey;
            const button = row.querySelector(".js-consolidado-cart");
            if (!rowKey || !button) {
                return;
            }
            button.addEventListener("click", function (event) {
                event.preventDefault();
                event.stopPropagation();
                if (highlightState[rowKey]) {
                    delete highlightState[rowKey];
                } else {
                    highlightState[rowKey] = true;
                }
                saveState(highlightStorageKey, highlightState);
                applyHighlightByKey(rowKey);
            });
            applyRowHighlight(row);
        });

        if (sucursalFilter) {
            sucursalFilter.addEventListener("change", applyFilters);
        }
        if (vidaUtilFilter) {
            vidaUtilFilter.addEventListener("change", applyFilters);
        }

        applyFilters();
    });
</script>
{% endblock %}
